<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>lisp.ml</title>
<link rel="stylesheet" type="text/css" href="../code.css">
<link rel="stylesheet" type="text/css" href="../highlight.css">
</head>
<body class="hl">
<pre class="hl"><span class="hl com">(*</span>
<span class="hl com"> * lisp.ml</span>
<span class="hl com"> *</span>
<span class="hl com"> * Basic lisp evaluator</span>
<span class="hl com"> *</span>
<span class="hl com"> * You can compile this file with the following command:</span>
<span class="hl com"> *</span>
<span class="hl com"> *     ocamlc -I +camlp4 -pp camlp4o lisp.ml -o lisp</span>
<span class="hl com"> *)</span>

<span class="hl com">(* Lex *)</span>

<span class="hl kwa">module</span> Tok <span class="hl opt">=</span>
  <span class="hl kwa">struct</span>
    <span class="hl kwa">type</span> token <span class="hl opt">=</span>
      <span class="hl opt">|</span> LPar
      <span class="hl opt">|</span> RPar
      <span class="hl opt">|</span> Def
      <span class="hl opt">|</span> Lam
      <span class="hl opt">|</span> If
      <span class="hl opt">|</span> True
      <span class="hl opt">|</span> False
      <span class="hl opt">|</span> Num <span class="hl kwa">of</span> <span class="hl kwb">float</span>
      <span class="hl opt">|</span> Var <span class="hl kwa">of</span> <span class="hl kwb">string</span>
  <span class="hl kwa">end</span>

<span class="hl kwa">let rec</span> <span class="hl kwd">lex</span> <span class="hl opt">=</span> parser
  <span class="hl opt">| [&lt;</span> &#39; <span class="hl opt">(</span>&#39; &#39; <span class="hl opt">|</span> &#39;<span class="hl esc">\n</span>&#39; <span class="hl opt">|</span> &#39;<span class="hl esc">\r</span>&#39; <span class="hl opt">|</span> &#39;<span class="hl esc">\t</span>&#39;<span class="hl opt">);</span> stream <span class="hl opt">&gt;] -&gt;</span> <span class="hl kwd">lex</span> stream
  <span class="hl opt">| [&lt;</span> &#39;&#39;<span class="hl opt">(</span>&#39;<span class="hl opt">;</span> stream <span class="hl opt">&gt;] -&gt; [&lt;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>LPar<span class="hl opt">;</span> <span class="hl kwd">lex</span> stream <span class="hl opt">&gt;]</span>
  <span class="hl opt">| [&lt;</span> &#39;&#39;<span class="hl opt">)</span>&#39;<span class="hl opt">;</span> stream <span class="hl opt">&gt;] -&gt; [&lt;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>RPar<span class="hl opt">;</span> <span class="hl kwd">lex</span> stream <span class="hl opt">&gt;]</span>
  <span class="hl opt">| [&lt;</span> &#39; <span class="hl opt">(</span>&#39;<span class="hl num">0</span>&#39; <span class="hl opt">..</span> &#39;<span class="hl num">9</span>&#39; <span class="hl kwa">as</span> c<span class="hl opt">);</span> stream <span class="hl opt">&gt;] -&gt;</span>
    <span class="hl kwa">let</span> <span class="hl kwd">buffer</span> <span class="hl opt">=</span> <span class="hl kwc">Buffer</span><span class="hl opt">.</span>create <span class="hl num">1</span> <span class="hl kwa">in</span>
    <span class="hl kwc">Buffer</span><span class="hl opt">.</span>add_char <span class="hl kwd">buffer</span> c<span class="hl opt">;</span>
    lex_number <span class="hl kwd">buffer</span> stream
  <span class="hl opt">| [&lt;</span> &#39;c<span class="hl opt">;</span> stream <span class="hl opt">&gt;] -&gt;</span>
    <span class="hl kwa">let</span> <span class="hl kwd">buffer</span> <span class="hl opt">=</span> <span class="hl kwc">Buffer</span><span class="hl opt">.</span>create <span class="hl num">1</span> <span class="hl kwa">in</span>
    <span class="hl kwc">Buffer</span><span class="hl opt">.</span>add_char <span class="hl kwd">buffer</span> c<span class="hl opt">;</span>
    lex_item <span class="hl kwd">buffer</span> stream
  <span class="hl opt">| [&lt; &gt;] -&gt; [&lt; &gt;]</span>

<span class="hl kwa">and</span> lex_number <span class="hl kwd">buffer</span> <span class="hl opt">=</span> parser
  <span class="hl opt">| [&lt;</span> &#39; <span class="hl opt">(</span>&#39;<span class="hl num">0</span>&#39; <span class="hl opt">..</span> &#39;<span class="hl num">9</span>&#39; <span class="hl opt">|</span> &#39;<span class="hl opt">.</span>&#39; <span class="hl kwa">as</span> c<span class="hl opt">);</span> stream <span class="hl opt">&gt;] -&gt;</span>
    <span class="hl kwc">Buffer</span><span class="hl opt">.</span>add_char <span class="hl kwd">buffer</span> c<span class="hl opt">;</span>
    lex_number <span class="hl kwd">buffer</span> stream
  <span class="hl opt">| [&lt;</span> stream <span class="hl opt">&gt;] -&gt;</span>
    <span class="hl kwa">let</span> <span class="hl kwd">contents</span> <span class="hl opt">=</span> <span class="hl kwc">Buffer</span><span class="hl opt">.</span><span class="hl kwd">contents buffer</span> <span class="hl kwa">in</span>
    <span class="hl kwa">let value</span> <span class="hl opt">=</span> float_of_string <span class="hl kwd">contents</span> <span class="hl kwa">in</span>
    <span class="hl kwa">let</span> <span class="hl kwd">token</span> <span class="hl opt">=</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>Num <span class="hl kwa">value in</span>
    <span class="hl opt">[&lt;</span> &#39;<span class="hl kwd">token</span><span class="hl opt">;</span> <span class="hl kwd">lex</span> stream <span class="hl opt">&gt;]</span>

<span class="hl kwa">and</span> lex_item <span class="hl kwd">buffer</span> <span class="hl opt">=</span> parser
  <span class="hl opt">| [&lt;</span> &#39; <span class="hl opt">(</span>&#39; &#39; <span class="hl opt">|</span> &#39;<span class="hl esc">\n</span>&#39; <span class="hl opt">|</span> &#39;<span class="hl esc">\r</span>&#39; <span class="hl opt">|</span> &#39;<span class="hl esc">\t</span>&#39;<span class="hl opt">);</span> stream <span class="hl opt">&gt;] -&gt;</span>
    <span class="hl opt">[&lt;</span> &#39;identify <span class="hl kwd">buffer</span><span class="hl opt">;</span> <span class="hl kwd">lex</span> stream <span class="hl opt">&gt;]</span>
  <span class="hl opt">| [&lt;</span> &#39;&#39;<span class="hl opt">(</span>&#39;<span class="hl opt">;</span> stream <span class="hl opt">&gt;] -&gt; [&lt;</span> &#39;identify <span class="hl kwd">buffer</span><span class="hl opt">;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>LPar<span class="hl opt">;</span> <span class="hl kwd">lex</span> stream <span class="hl opt">&gt;]</span>
  <span class="hl opt">| [&lt;</span> &#39;&#39;<span class="hl opt">)</span>&#39;<span class="hl opt">;</span> stream <span class="hl opt">&gt;] -&gt; [&lt;</span> &#39;identify <span class="hl kwd">buffer</span><span class="hl opt">;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>RPar<span class="hl opt">;</span> <span class="hl kwd">lex</span> stream <span class="hl opt">&gt;]</span>
  <span class="hl opt">| [&lt;</span> &#39;c<span class="hl opt">;</span> stream <span class="hl opt">&gt;] -&gt;</span>
    <span class="hl kwc">Buffer</span><span class="hl opt">.</span>add_char <span class="hl kwd">buffer</span> c<span class="hl opt">;</span>
    lex_item <span class="hl kwd">buffer</span> stream
  <span class="hl opt">| [&lt; &gt;] -&gt; [&lt;</span> &#39;identify <span class="hl kwd">buffer</span> <span class="hl opt">&gt;]</span>

<span class="hl kwa">and</span> identify <span class="hl kwd">buffer</span> <span class="hl opt">=</span>
  <span class="hl kwa">let</span> <span class="hl kwd">contents</span> <span class="hl opt">=</span> <span class="hl kwc">Buffer</span><span class="hl opt">.</span><span class="hl kwd">contents buffer</span> <span class="hl kwa">in</span>
  <span class="hl kwa">match</span> <span class="hl kwd">contents</span> <span class="hl kwa">with</span>
  <span class="hl opt">|</span> <span class="hl str">&quot;define&quot;</span> <span class="hl opt">-&gt;</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>Def
  <span class="hl opt">|</span> <span class="hl str">&quot;lambda&quot;</span> <span class="hl opt">-&gt;</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>Lam
  <span class="hl opt">|</span> <span class="hl str">&quot;if&quot;</span> <span class="hl opt">-&gt;</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>If
  <span class="hl opt">|</span> <span class="hl str">&quot;#t&quot;</span> <span class="hl opt">-&gt;</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>True
  <span class="hl opt">|</span> <span class="hl str">&quot;#f&quot;</span> <span class="hl opt">-&gt;</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>False
  <span class="hl opt">|</span> <span class="hl kwd">contents</span> <span class="hl opt">-&gt;</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>Var <span class="hl kwd">contents</span>

<span class="hl kwa">let</span> <span class="hl kwd">string_of_token</span> <span class="hl opt">=</span> <span class="hl kwa">function</span>
  <span class="hl opt">|</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>LPar <span class="hl opt">-&gt;</span> <span class="hl str">&quot;(&quot;</span>
  <span class="hl opt">|</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>RPar <span class="hl opt">-&gt;</span> <span class="hl str">&quot;)&quot;</span>
  <span class="hl opt">|</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>Def <span class="hl opt">-&gt;</span> <span class="hl str">&quot;define&quot;</span>
  <span class="hl opt">|</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>Lam <span class="hl opt">-&gt;</span> <span class="hl str">&quot;lambda&quot;</span>
  <span class="hl opt">|</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>If <span class="hl opt">-&gt;</span> <span class="hl str">&quot;if&quot;</span>
  <span class="hl opt">|</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>True <span class="hl opt">-&gt;</span> <span class="hl str">&quot;#t&quot;</span>
  <span class="hl opt">|</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>False <span class="hl opt">-&gt;</span> <span class="hl str">&quot;#f&quot;</span>
  <span class="hl opt">|</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>Num num <span class="hl opt">-&gt;</span> string_of_float num
  <span class="hl opt">|</span> <span class="hl kwc">Tok</span><span class="hl opt">.</span>Var var <span class="hl opt">-&gt;</span> var

<span class="hl kwa">let</span> <span class="hl kwd">print_token token</span> <span class="hl opt">=</span> <span class="hl kwd">token</span> <span class="hl opt">|&gt;</span> <span class="hl kwd">string_of_token</span> <span class="hl opt">|&gt;</span> print_endline

<span class="hl com">(* Parse *)</span>

<span class="hl kwa">module</span> Exp <span class="hl opt">=</span> <span class="hl kwa">struct</span>
  <span class="hl kwa">type</span> expr <span class="hl opt">=</span>
    <span class="hl opt">|</span> Nil
    <span class="hl opt">|</span> Bool <span class="hl kwa">of</span> <span class="hl kwb">bool</span>
    <span class="hl opt">|</span> Num <span class="hl kwa">of</span> <span class="hl kwb">float</span>
    <span class="hl opt">|</span> Var <span class="hl kwa">of</span> <span class="hl kwb">string</span>
    <span class="hl opt">|</span> Cond <span class="hl kwa">of</span> expr <span class="hl opt">*</span> expr <span class="hl opt">*</span> expr
    <span class="hl opt">|</span> Def <span class="hl kwa">of</span> expr <span class="hl opt">*</span> expr
    <span class="hl opt">|</span> Lam <span class="hl kwa">of</span> expr list <span class="hl opt">*</span> expr
    <span class="hl opt">|</span> Blt <span class="hl kwa">of</span> <span class="hl opt">(</span>expr list <span class="hl opt">-&gt;</span> expr<span class="hl opt">)</span>
    <span class="hl opt">|</span> App <span class="hl kwa">of</span> expr <span class="hl opt">*</span> expr list
<span class="hl kwa">end</span>

<span class="hl kwa">let rec</span> <span class="hl kwd">parse</span> <span class="hl opt">=</span> parser
  <span class="hl opt">| [&lt;</span> expr<span class="hl opt">=</span><span class="hl kwd">parse_expr</span><span class="hl opt">;</span> stream <span class="hl opt">&gt;] -&gt;</span>
    print_string <span class="hl str">&quot;-&gt; &quot;</span><span class="hl opt">;</span> flush stdout<span class="hl opt">;</span>
    <span class="hl opt">[&lt;</span> &#39;expr<span class="hl opt">;</span> <span class="hl kwd">parse</span> stream <span class="hl opt">&gt;]</span>
  <span class="hl opt">| [&lt; &gt;] -&gt; [&lt; &gt;]</span>

<span class="hl kwa">and</span> <span class="hl kwd">parse_expr</span> <span class="hl opt">=</span> parser
  <span class="hl opt">| [&lt;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>LPar<span class="hl opt">;</span> stream <span class="hl opt">&gt;] -&gt;</span> parse_list stream
  <span class="hl opt">| [&lt;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>True<span class="hl opt">;</span> _ <span class="hl opt">&gt;] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Bool <span class="hl kwa">true</span>
  <span class="hl opt">| [&lt;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>False<span class="hl opt">;</span> _ <span class="hl opt">&gt;] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Bool <span class="hl kwa">false</span>
  <span class="hl opt">| [&lt;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>Num num<span class="hl opt">;</span> _ <span class="hl opt">&gt;] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Num num
  <span class="hl opt">| [&lt;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>Var var<span class="hl opt">;</span> _ <span class="hl opt">&gt;] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Var var

<span class="hl kwa">and</span> parse_list <span class="hl opt">=</span> parser
  <span class="hl opt">| [&lt;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>RPar<span class="hl opt">;</span> _ <span class="hl opt">&gt;] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Nil
  <span class="hl opt">| [&lt;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>If<span class="hl opt">;</span>
       con<span class="hl opt">=</span><span class="hl kwd">parse_expr</span><span class="hl opt">;</span>
       expr1<span class="hl opt">=</span><span class="hl kwd">parse_expr</span><span class="hl opt">;</span>
       expr2<span class="hl opt">=</span><span class="hl kwd">parse_expr</span><span class="hl opt">;</span>
       &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>RPar<span class="hl opt">;</span> _ <span class="hl opt">&gt;] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Cond <span class="hl opt">(</span>con<span class="hl opt">,</span> expr1<span class="hl opt">,</span> expr2<span class="hl opt">)</span>
  <span class="hl opt">| [&lt;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>Def<span class="hl opt">; (</span>var<span class="hl opt">,</span> expr<span class="hl opt">)=</span>parse_def<span class="hl opt">;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>RPar<span class="hl opt">;</span> _ <span class="hl opt">&gt;] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Def <span class="hl opt">(</span>var<span class="hl opt">,</span> expr<span class="hl opt">)</span>
  <span class="hl opt">| [&lt;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>Lam<span class="hl opt">;</span>
       &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>LPar<span class="hl opt">;</span>
       args<span class="hl opt">=</span>parse_args <span class="hl opt">[];</span>
       expr<span class="hl opt">=</span><span class="hl kwd">parse_expr</span><span class="hl opt">;</span>
       &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>RPar<span class="hl opt">;</span> _ <span class="hl opt">&gt;] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Lam <span class="hl opt">(</span>args<span class="hl opt">,</span> expr<span class="hl opt">)</span>
  <span class="hl opt">| [&lt;</span> func<span class="hl opt">=</span><span class="hl kwd">parse_expr</span><span class="hl opt">;</span> args<span class="hl opt">=</span>parse_args <span class="hl opt">[];</span> _ <span class="hl opt">&gt;] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>App <span class="hl opt">(</span>func<span class="hl opt">,</span> args<span class="hl opt">)</span>

<span class="hl kwa">and</span> parse_def <span class="hl opt">=</span> parser
  <span class="hl opt">| [&lt;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>LPar<span class="hl opt">;</span>
       var<span class="hl opt">=</span><span class="hl kwd">parse_expr</span><span class="hl opt">;</span>
       args<span class="hl opt">=</span>parse_args <span class="hl opt">[];</span>
       expr<span class="hl opt">=</span><span class="hl kwd">parse_expr</span><span class="hl opt">;</span> _ <span class="hl opt">&gt;] -&gt; (</span>var<span class="hl opt">,</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Lam <span class="hl opt">(</span>args<span class="hl opt">,</span> expr<span class="hl opt">))</span>
  <span class="hl opt">| [&lt;</span> var<span class="hl opt">=</span><span class="hl kwd">parse_expr</span><span class="hl opt">;</span> expr<span class="hl opt">=</span><span class="hl kwd">parse_expr</span><span class="hl opt">;</span> _ <span class="hl opt">&gt;] -&gt; (</span>var<span class="hl opt">,</span> expr<span class="hl opt">)</span>

<span class="hl kwa">and</span> parse_args acc <span class="hl opt">=</span> parser
  <span class="hl opt">| [&lt;</span> &#39;<span class="hl kwc">Tok</span><span class="hl opt">.</span>RPar<span class="hl opt">;</span> _ <span class="hl opt">&gt;] -&gt;</span> <span class="hl kwc">List</span><span class="hl opt">.</span>rev acc
  <span class="hl opt">| [&lt;</span> arg<span class="hl opt">=</span><span class="hl kwd">parse_expr</span><span class="hl opt">;</span> stream <span class="hl opt">&gt;] -&gt;</span> parse_args <span class="hl opt">(</span>arg <span class="hl opt">::</span> acc<span class="hl opt">)</span> stream

<span class="hl kwa">let rec</span> <span class="hl kwd">string_of_expr</span> <span class="hl opt">=</span> <span class="hl kwa">function</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Nil <span class="hl opt">-&gt;</span> <span class="hl str">&quot;nil&quot;</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Num num <span class="hl opt">-&gt;</span> string_of_float num
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Var var <span class="hl opt">-&gt;</span> var
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Bool <span class="hl kwa">true</span> <span class="hl opt">-&gt;</span> <span class="hl str">&quot;#t&quot;</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Bool <span class="hl kwa">false</span> <span class="hl opt">-&gt;</span> <span class="hl str">&quot;#f&quot;</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Cond <span class="hl opt">(</span>con<span class="hl opt">,</span> expr1<span class="hl opt">,</span> expr2<span class="hl opt">) -&gt;</span>
    <span class="hl kwa">let</span> <span class="hl kwd">con</span> <span class="hl opt">=</span> <span class="hl kwd">string_of_expr con</span> <span class="hl kwa">in</span>
    <span class="hl kwa">let</span> <span class="hl kwd">expr1</span> <span class="hl opt">=</span> <span class="hl kwd">string_of_expr expr1</span> <span class="hl kwa">in</span>
    <span class="hl kwa">let</span> <span class="hl kwd">expr2</span> <span class="hl opt">=</span> <span class="hl kwd">string_of_expr expr2</span> <span class="hl kwa">in</span>
    <span class="hl str">&quot;(if &quot;</span> ^ <span class="hl kwd">con</span> ^ <span class="hl str">&quot; &quot;</span> ^ <span class="hl kwd">expr1</span> ^ <span class="hl str">&quot; &quot;</span> ^ <span class="hl kwd">expr2</span> ^ <span class="hl str">&quot;)&quot;</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Def <span class="hl opt">(</span>var<span class="hl opt">,</span> expr<span class="hl opt">) -&gt;</span>
    <span class="hl kwa">let</span> <span class="hl kwd">var</span> <span class="hl opt">=</span> <span class="hl kwd">string_of_expr var</span> <span class="hl kwa">in</span>
    <span class="hl kwa">let</span> <span class="hl kwd">expr</span> <span class="hl opt">=</span> <span class="hl kwd">string_of_expr expr</span> <span class="hl kwa">in</span>
    <span class="hl str">&quot;(define &quot;</span> ^ <span class="hl kwd">var</span> ^ <span class="hl str">&quot; &quot;</span> ^ <span class="hl kwd">expr</span> ^ <span class="hl str">&quot;)&quot;</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Lam <span class="hl opt">(</span>args<span class="hl opt">,</span> <span class="hl kwd">expr</span><span class="hl opt">) -&gt;</span>
    <span class="hl kwa">let</span> <span class="hl kwd">args</span> <span class="hl opt">=</span> <span class="hl kwd">args</span> <span class="hl opt">|&gt;</span> <span class="hl kwc">List</span><span class="hl opt">.</span>map <span class="hl kwd">string_of_expr</span> <span class="hl opt">|&gt;</span> <span class="hl kwc">String</span><span class="hl opt">.</span>concat <span class="hl str">&quot; &quot;</span> <span class="hl kwa">in</span>
    <span class="hl kwa">let</span> <span class="hl kwd">expr</span> <span class="hl opt">=</span> <span class="hl kwd">string_of_expr expr</span> <span class="hl kwa">in</span>
    <span class="hl str">&quot;(lambda (&quot;</span> ^ <span class="hl kwd">args</span> ^ <span class="hl str">&quot;) &quot;</span> ^ <span class="hl kwd">expr</span> ^ <span class="hl str">&quot;)&quot;</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>App <span class="hl opt">(</span>func<span class="hl opt">,</span> <span class="hl kwd">args</span><span class="hl opt">) -&gt;</span>
    <span class="hl kwa">let</span> <span class="hl kwd">func</span> <span class="hl opt">=</span> <span class="hl kwd">string_of_expr func</span> <span class="hl kwa">in</span>
    <span class="hl kwa">let</span> <span class="hl kwd">args</span> <span class="hl opt">=</span> <span class="hl kwd">args</span> <span class="hl opt">|&gt;</span> <span class="hl kwc">List</span><span class="hl opt">.</span>map <span class="hl kwd">string_of_expr</span> <span class="hl opt">|&gt;</span> <span class="hl kwc">String</span><span class="hl opt">.</span>concat <span class="hl str">&quot; &quot;</span> <span class="hl kwa">in</span>
    <span class="hl str">&quot;(&quot;</span> ^ <span class="hl kwd">func</span> ^ <span class="hl str">&quot; &quot;</span> ^ <span class="hl kwd">args</span> ^ <span class="hl str">&quot;)&quot;</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Blt blt <span class="hl opt">-&gt;</span> <span class="hl kwa">assert false</span>

<span class="hl kwa">let</span> <span class="hl kwd">print_expr expr</span> <span class="hl opt">=</span> <span class="hl kwd">expr</span> <span class="hl opt">|&gt;</span> <span class="hl kwd">string_of_expr</span> <span class="hl opt">|&gt;</span> print_endline

<span class="hl com">(* Eval *)</span>

<span class="hl kwa">let rec</span> <span class="hl kwd">eval</span> env <span class="hl opt">=</span> parser
  <span class="hl opt">| [&lt;</span> &#39;<span class="hl kwd">expr</span><span class="hl opt">;</span> stream <span class="hl opt">&gt;] -&gt;</span>
    <span class="hl kwa">begin try</span>
      <span class="hl kwa">let</span> <span class="hl opt">(</span>res<span class="hl opt">,</span> env<span class="hl opt">) =</span> eval_expr env <span class="hl kwd">expr</span> <span class="hl kwa">in</span>
      <span class="hl kwd">print_expr</span> res<span class="hl opt">;</span>
      <span class="hl kwd">eval</span> env stream
    <span class="hl kwa">with</span>
    <span class="hl opt">|</span> Failure err <span class="hl opt">-&gt;</span> print_endline err<span class="hl opt">;</span> <span class="hl kwd">eval</span> env stream
    <span class="hl kwa">end</span><span class="hl opt">;</span>
  <span class="hl opt">| [&lt; &gt;] -&gt; [&lt; &gt;]</span>

<span class="hl kwa">and</span> eval_expr env <span class="hl opt">=</span> <span class="hl kwa">function</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Nil <span class="hl kwa">as</span> nil <span class="hl opt">-&gt; (</span>nil<span class="hl opt">,</span> env<span class="hl opt">)</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Bool _ <span class="hl kwa">as</span> <span class="hl kwd">con</span> <span class="hl opt">-&gt; (</span><span class="hl kwd">con</span><span class="hl opt">,</span> env<span class="hl opt">)</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Num _ <span class="hl kwa">as</span> num <span class="hl opt">-&gt; (</span>num<span class="hl opt">,</span> env<span class="hl opt">)</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Var _ <span class="hl kwa">as</span> <span class="hl kwd">var</span> <span class="hl opt">-&gt;</span>
    <span class="hl kwa">let</span> <span class="hl kwd">res</span> <span class="hl opt">=</span> lookup <span class="hl kwd">var</span> env <span class="hl kwa">in</span>
    <span class="hl opt">(</span><span class="hl kwd">res</span><span class="hl opt">,</span> env<span class="hl opt">)</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Cond <span class="hl opt">(</span>cond<span class="hl opt">,</span> <span class="hl kwd">expr1</span><span class="hl opt">,</span> <span class="hl kwd">expr2</span><span class="hl opt">) -&gt;</span>
    <span class="hl kwa">begin match</span> fst<span class="hl opt">(</span>eval_expr env cond<span class="hl opt">)</span> <span class="hl kwa">with</span>
    <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Bool <span class="hl kwa">true</span> <span class="hl opt">-&gt;</span> eval_expr env <span class="hl kwd">expr1</span>
    <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Bool <span class="hl kwa">false</span> <span class="hl opt">-&gt;</span> eval_expr env <span class="hl kwd">expr2</span>
    <span class="hl opt">|</span> _ <span class="hl opt">-&gt;</span> failwith <span class="hl str">&quot;ERROR: expected boolean&quot;</span>
    <span class="hl kwa">end</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Def <span class="hl opt">(</span><span class="hl kwd">var</span><span class="hl opt">,</span> <span class="hl kwd">expr</span><span class="hl opt">) -&gt; (</span><span class="hl kwc">Exp</span><span class="hl opt">.</span>Nil<span class="hl opt">, (</span><span class="hl kwd">var</span><span class="hl opt">,</span> <span class="hl kwd">expr</span><span class="hl opt">) ::</span> env<span class="hl opt">)</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Lam <span class="hl opt">(</span>_<span class="hl opt">,</span> _<span class="hl opt">)</span> <span class="hl kwa">as</span> lam <span class="hl opt">-&gt; (</span>lam<span class="hl opt">,</span> env<span class="hl opt">)</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Blt _ <span class="hl kwa">as</span> blt <span class="hl opt">-&gt; (</span>blt<span class="hl opt">,</span> env<span class="hl opt">)</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>App <span class="hl opt">(</span><span class="hl kwd">func</span><span class="hl opt">,</span> <span class="hl kwd">args</span><span class="hl opt">) -&gt;</span>
    <span class="hl kwa">let</span> <span class="hl kwd">args</span> <span class="hl opt">=</span> <span class="hl kwc">List</span><span class="hl opt">.</span>map <span class="hl opt">(</span><span class="hl kwa">fun</span> <span class="hl kwd">expr</span> <span class="hl opt">-&gt;</span> fst<span class="hl opt">(</span>eval_expr env <span class="hl kwd">expr</span><span class="hl opt">))</span> <span class="hl kwd">args</span> <span class="hl kwa">in</span>
    <span class="hl kwa">begin match</span> fst<span class="hl opt">(</span>eval_expr env <span class="hl kwd">func</span><span class="hl opt">)</span> <span class="hl kwa">with</span>
    <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Lam <span class="hl opt">(</span>vars<span class="hl opt">,</span> <span class="hl kwd">expr</span><span class="hl opt">) -&gt;</span>
      <span class="hl kwa">if</span> <span class="hl kwc">List</span><span class="hl opt">.</span>length vars <span class="hl opt">&lt;&gt;</span> <span class="hl kwc">List</span><span class="hl opt">.</span>length <span class="hl kwd">args</span>
      <span class="hl kwa">then</span> failwith <span class="hl str">&quot;ERROR: wrong number of arguments&quot;</span><span class="hl opt">;</span>
      <span class="hl kwa">let</span> <span class="hl kwd">binds</span> <span class="hl opt">=</span> <span class="hl kwc">List</span><span class="hl opt">.</span>combine vars <span class="hl kwd">args</span> <span class="hl kwa">in</span>
      <span class="hl kwa">let</span> <span class="hl kwd">res</span> <span class="hl opt">=</span> fst<span class="hl opt">(</span>eval_expr <span class="hl opt">(</span><span class="hl kwd">binds</span> <span class="hl opt">&#64;</span> env<span class="hl opt">)</span> <span class="hl kwd">expr</span><span class="hl opt">)</span> <span class="hl kwa">in</span>
      <span class="hl opt">(</span><span class="hl kwd">res</span><span class="hl opt">,</span> env<span class="hl opt">)</span>
    <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Blt <span class="hl kwd">func</span> <span class="hl opt">-&gt;</span>
      <span class="hl kwa">let</span> <span class="hl kwd">res</span> <span class="hl opt">=</span> <span class="hl kwd">func args</span> <span class="hl kwa">in</span>
      <span class="hl opt">(</span><span class="hl kwd">res</span><span class="hl opt">,</span> env<span class="hl opt">)</span>
    <span class="hl opt">|</span> _ <span class="hl opt">-&gt;</span> failwith <span class="hl str">&quot;ERROR: expected function&quot;</span>
    <span class="hl kwa">end</span>

<span class="hl kwa">and</span> lookup <span class="hl kwd">var</span> <span class="hl opt">=</span> <span class="hl kwa">function</span>
  <span class="hl opt">| (</span>v<span class="hl opt">,</span> e<span class="hl opt">) ::</span> tl <span class="hl opt">-&gt;</span> <span class="hl kwa">if</span> v <span class="hl opt">=</span> <span class="hl kwd">var</span> <span class="hl kwa">then</span> e <span class="hl kwa">else</span> lookup <span class="hl kwd">var</span> tl
  <span class="hl opt">|</span> _ <span class="hl opt">-&gt;</span> failwith <span class="hl str">&quot;ERROR: unbound variable&quot;</span>

<span class="hl com">(* Built-in functions *)</span>

<span class="hl kwa">let</span> <span class="hl kwd">eq</span> <span class="hl opt">=</span> <span class="hl kwa">function</span>
  <span class="hl opt">|</span> x <span class="hl opt">::</span> y <span class="hl opt">:: [] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Bool <span class="hl opt">(</span>x <span class="hl opt">=</span> y<span class="hl opt">)</span>
  <span class="hl opt">|</span> _ <span class="hl opt">-&gt;</span> <span class="hl kwa">assert false</span>

<span class="hl kwa">let</span> <span class="hl kwd">lt</span> <span class="hl opt">=</span> <span class="hl kwa">function</span>
  <span class="hl opt">|</span> x <span class="hl opt">::</span> y <span class="hl opt">:: [] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Bool <span class="hl opt">(</span>x <span class="hl opt">&lt;</span> y<span class="hl opt">)</span>
  <span class="hl opt">|</span> _ <span class="hl opt">-&gt;</span> <span class="hl kwa">assert false</span>

<span class="hl kwa">let</span> <span class="hl kwd">gt</span> <span class="hl opt">=</span> <span class="hl kwa">function</span>
  <span class="hl opt">|</span> x <span class="hl opt">::</span> y <span class="hl opt">:: [] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Bool <span class="hl opt">(</span>x <span class="hl opt">&gt;</span> y<span class="hl opt">)</span>
  <span class="hl opt">|</span> _ <span class="hl opt">-&gt;</span> <span class="hl kwa">assert false</span>

<span class="hl kwa">let</span> <span class="hl kwd">le</span> <span class="hl opt">=</span> <span class="hl kwa">function</span>
  <span class="hl opt">|</span> x <span class="hl opt">::</span> y <span class="hl opt">:: [] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Bool <span class="hl opt">(</span>x <span class="hl opt">&lt;=</span> y<span class="hl opt">)</span>
  <span class="hl opt">|</span> _ <span class="hl opt">-&gt;</span> <span class="hl kwa">assert false</span>

<span class="hl kwa">let</span> <span class="hl kwd">ge</span> <span class="hl opt">=</span> <span class="hl kwa">function</span>
  <span class="hl opt">|</span> x <span class="hl opt">::</span> y <span class="hl opt">:: [] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Bool <span class="hl opt">(</span>x <span class="hl opt">&gt;=</span> y<span class="hl opt">)</span>
  <span class="hl opt">|</span> _ <span class="hl opt">-&gt;</span> <span class="hl kwa">assert false</span>

<span class="hl kwa">let</span> <span class="hl kwd">binop</span> f x z <span class="hl opt">=</span>
  <span class="hl kwa">match</span> <span class="hl opt">(</span>x<span class="hl opt">,</span> z<span class="hl opt">)</span> <span class="hl kwa">with</span>
  <span class="hl opt">| ((</span><span class="hl kwc">Exp</span><span class="hl opt">.</span>Num x<span class="hl opt">), (</span><span class="hl kwc">Exp</span><span class="hl opt">.</span>Num z<span class="hl opt">)) -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Num <span class="hl opt">(</span>f x z<span class="hl opt">)</span>
  <span class="hl opt">|</span> _ <span class="hl opt">-&gt;</span> <span class="hl kwa">assert false</span>

<span class="hl kwa">let</span> <span class="hl kwd">add</span> <span class="hl opt">=</span> <span class="hl kwc">List</span><span class="hl opt">.</span>fold_left <span class="hl opt">(</span><span class="hl kwd">binop</span> <span class="hl opt">(+.)) (</span><span class="hl kwc">Exp</span><span class="hl opt">.</span>Num <span class="hl num">0.0</span><span class="hl opt">)</span>

<span class="hl kwa">let</span> <span class="hl kwd">mul</span> <span class="hl opt">=</span> <span class="hl kwc">List</span><span class="hl opt">.</span>fold_left <span class="hl opt">(</span><span class="hl kwd">binop</span> <span class="hl opt">( *. )) (</span><span class="hl kwc">Exp</span><span class="hl opt">.</span>Num <span class="hl num">1.0</span><span class="hl opt">)</span>

<span class="hl kwa">let</span> <span class="hl kwd">sub</span> <span class="hl opt">=</span> <span class="hl kwa">function</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Num hd <span class="hl opt">:: [] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Num <span class="hl opt">(</span><span class="hl num">0.0</span> <span class="hl opt">-.</span> hd<span class="hl opt">)</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Num hd <span class="hl opt">::</span> tl <span class="hl opt">-&gt;</span>
    <span class="hl kwa">begin match</span> <span class="hl kwd">add</span> tl <span class="hl kwa">with</span>
    <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Num rest <span class="hl opt">-&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Num <span class="hl opt">(</span>hd <span class="hl opt">-.</span> rest<span class="hl opt">)</span>
    <span class="hl opt">|</span> _ <span class="hl opt">-&gt;</span> <span class="hl kwa">assert false</span>
    <span class="hl kwa">end</span>
  <span class="hl opt">|</span> _ <span class="hl opt">-&gt;</span> <span class="hl kwa">assert false</span>

<span class="hl kwa">let</span> <span class="hl kwd">div</span> <span class="hl opt">=</span> <span class="hl kwa">function</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Num hd <span class="hl opt">:: [] -&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Num <span class="hl opt">(</span><span class="hl num">1.0</span> <span class="hl opt">/.</span> hd<span class="hl opt">)</span>
  <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Num hd <span class="hl opt">::</span> tl <span class="hl opt">-&gt;</span>
    <span class="hl kwa">begin match</span> <span class="hl kwd">mul</span> tl <span class="hl kwa">with</span>
    <span class="hl opt">|</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Num rest <span class="hl opt">-&gt;</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Num <span class="hl opt">(</span>hd <span class="hl opt">/.</span> rest<span class="hl opt">)</span>
    <span class="hl opt">|</span> _ <span class="hl opt">-&gt;</span> <span class="hl kwa">assert false</span>
    <span class="hl kwa">end</span>
  <span class="hl opt">|</span> _ <span class="hl opt">-&gt;</span> <span class="hl kwa">assert false</span>

<span class="hl kwa">let</span> <span class="hl kwd">env</span> <span class="hl opt">= [</span>
  <span class="hl opt">(</span><span class="hl kwc">Exp</span><span class="hl opt">.</span>Var <span class="hl str">&quot;+&quot;</span><span class="hl opt">,</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Blt <span class="hl kwd">add</span><span class="hl opt">);</span>
  <span class="hl opt">(</span><span class="hl kwc">Exp</span><span class="hl opt">.</span>Var <span class="hl str">&quot;-&quot;</span><span class="hl opt">,</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Blt <span class="hl kwd">sub</span><span class="hl opt">);</span>
  <span class="hl opt">(</span><span class="hl kwc">Exp</span><span class="hl opt">.</span>Var <span class="hl str">&quot;*&quot;</span><span class="hl opt">,</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Blt <span class="hl kwd">mul</span><span class="hl opt">);</span>
  <span class="hl opt">(</span><span class="hl kwc">Exp</span><span class="hl opt">.</span>Var <span class="hl str">&quot;/&quot;</span><span class="hl opt">,</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Blt <span class="hl kwd">div</span><span class="hl opt">);</span>
  <span class="hl opt">(</span><span class="hl kwc">Exp</span><span class="hl opt">.</span>Var <span class="hl str">&quot;=&quot;</span><span class="hl opt">,</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Blt <span class="hl kwd">eq</span><span class="hl opt">);</span>
  <span class="hl opt">(</span><span class="hl kwc">Exp</span><span class="hl opt">.</span>Var <span class="hl str">&quot;&lt;&quot;</span><span class="hl opt">,</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Blt <span class="hl kwd">lt</span><span class="hl opt">);</span>
  <span class="hl opt">(</span><span class="hl kwc">Exp</span><span class="hl opt">.</span>Var <span class="hl str">&quot;&gt;&quot;</span><span class="hl opt">,</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Blt <span class="hl kwd">gt</span><span class="hl opt">);</span>
  <span class="hl opt">(</span><span class="hl kwc">Exp</span><span class="hl opt">.</span>Var <span class="hl str">&quot;&lt;=&quot;</span><span class="hl opt">,</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Blt <span class="hl kwd">le</span><span class="hl opt">);</span>
  <span class="hl opt">(</span><span class="hl kwc">Exp</span><span class="hl opt">.</span>Var <span class="hl str">&quot;&gt;=&quot;</span><span class="hl opt">,</span> <span class="hl kwc">Exp</span><span class="hl opt">.</span>Blt <span class="hl kwd">ge</span><span class="hl opt">);</span>
<span class="hl opt">]</span>

<span class="hl com">(* Read-Eval-Print-Loop (REPL) *)</span>

<span class="hl kwa">let rec</span> <span class="hl kwd">print</span> <span class="hl opt">=</span> parser
  <span class="hl opt">| [&lt;</span> &#39;<span class="hl kwd">expr</span><span class="hl opt">;</span> stream <span class="hl opt">&gt;] -&gt;</span>
    <span class="hl kwd">print_expr expr</span><span class="hl opt">;</span>
    <span class="hl kwd">print</span> stream
  <span class="hl opt">| [&lt; &gt;] -&gt; ()</span>

<span class="hl kwa">let</span> <span class="hl opt">() =</span>
  stdin
  <span class="hl opt">|&gt;</span> <span class="hl kwc">Stream</span><span class="hl opt">.</span>of_channel
  <span class="hl opt">|&gt;</span> <span class="hl kwd">lex</span>
  <span class="hl opt">|&gt;</span> <span class="hl kwd">parse</span>
  <span class="hl opt">|&gt;</span> <span class="hl kwd">eval env</span>
  <span class="hl opt">|&gt;</span> <span class="hl kwd">print</span>
</pre>
</body>
</html>
<!--HTML generated by highlight 3.62, http://www.andre-simon.de/-->
